------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  D:\User_Data\Documents\GitHub\1_Million\cd20210211weekc.log
  log type:  text
 opened on:   2 Mar 2021, 09:32:16

. 
. // global datapath "F:\1Million\Documentation\"
. global datapath "D:\User_Data\Desktop\kan-2\1_Million\"

. // global datapath "d:\1Million\Documentation\"
. global dayrange "60" 

. global wrange "8"

. local  dayrange =$dayrange

. local  wrange =$wrange

. local year1=2004

. local year2=2005

. local yr1=substr("`year1'",3,2)

. local yr2=substr("`year2'",3,2)

. if `year2'==2006{
.                    local march20="0318"
.                 }

. if `year2'==2005{
.                    local march20="0319"
.                 }

. 
. //local datatype = "temp"
. local datatype = "all"

. 
. global dataCD04temp "CD`year1'_one_tenth.dta"

. global dataCD04all  "CD`year1'.dta"

. 
. global dataCD05temp "CD`year2'_one_tenth.dta"

. global dataCD05all  "CD`year2'.dta"

. 
. //create R(+-30 days of specific Saturday `year1'0320 )
. use $datapath\${dataCD04`datatype'} ,clear

. 
. preserve

. // gen R1=date(FUNC_DATE,"YMD")
. // gen Rw6=wofd(R1-2)
. //gen Rw =wofd(R1)
. gen R=date(FUNC_DATE,"YMD")-date("`year1'0320","YMD")

. gen abs_R=abs(R)

. keep if abs_R<=$dayrange
(8,490,293 observations deleted)

. sort FUNC_DATE

. tempfile unique_R

. keep R

. duplicates drop 

Duplicates in terms of all variables

(4,066,761 observations deleted)

. save `unique_R',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000002.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000002.tmp saved

. restore

. 
. drop if ID==""
(0 observations deleted)

. tempfile id`year1'

. keep ID ID_BIRTHDAY ID_SEX

. qui compress

. save `id`year1'',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000003.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000003.tmp saved

. 
. 
. 
. use $datapath\${dataCD05`datatype'} ,clear

. drop if ID==""
(12,557,168 observations deleted)

. tempfile id0405

. keep ID ID_BIRTHDAY ID_SEX

. append using `id`year1''

. duplicates drop

Duplicates in terms of all variables

(24,951,003 observations deleted)

. qui compress

. save `id0405',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000004.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000004.tmp saved

. 
. 
. use `id0405',clear

. duplicates drop

Duplicates in terms of all variables

(0 observations are duplicates)

. cross using `unique_R'

. tempfile unique_R_cross_ID

. count
  105,111,732

. qui compress

. save `unique_R_cross_ID',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000005.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000005.tmp saved

. 
. 
. use $datapath\${dataCD04`datatype'} ,clear

. gen R1=date(FUNC_DATE,"YMD")

. gen Rw6=wofd(R1-2)

. gen Rw =wofd(R1)

. gen R=date(FUNC_DATE,"YMD")-date("`year1'0320","YMD")

. gen abs_R=abs(R)

. keep if abs_R<=$dayrange
(8,490,293 observations deleted)

. global spirit = "290/319 319"

. qui icd9 check ACODE_ICD9_1   ,  gen(ivicd1)
ACODE_ICD9_1 contains invalid codes:

. qui icd9  gen  ICD_spirit = ACODE_ICD9_1     if  (ivicd1 ==0 ) , range("$spirit")       /*icd9*/

. gen cd_count=1

. gen cd_spirit_count=1 if ICD_spirit==1
(3,992,721 missing values generated)

. 
. /*For each R and ID count it's CD record happened in `year1' i.g ID:E110000000 went to clinic for de
> pressive disorder twice on `year1'/03/18 then 
> it will record 2 on ID:E110000000 R:-2 CD`year1'=2 cd`year1'_spirit=2 
> */
. egen cd_`year1'=sum(cd_count), by(ID R)

. egen cd_`year1'_spirit=sum(cd_spirit_count) if ICD_spirit==1 , by(ID R)
(3,992,721 missing values generated)

. replace cd_`year1'=0 if missing(cd_`year1')
(0 real changes made)

. replace cd_`year1'_spirit=0 if missing(cd_`year1'_spirit)
(3,992,721 real changes made)

. keep ID R ID_BIRTHDAY cd_`year1' cd_`year1'_spirit 

. duplicates drop ID R, force

Duplicates in terms of ID R

(300,863 observations deleted)

. tempfile ID_R_CD_`year1'

. qui compress

. save `ID_R_CD_`year1'',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000006.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000006.tmp saved

. //0319
. use $datapath\${dataCD05`datatype'},clear

. gen R=date(FUNC_DATE,"YMD")-date("`year2'`march20'","YMD")
(12,557,168 missing values generated)

. gen abs_R=abs(R)
(12,557,168 missing values generated)

. keep if abs_R<=$dayrange
(21,199,218 observations deleted)

. global spirit = "290/319 319"

. qui icd9 check ACODE_ICD9_1   ,  gen(ivicd1)
ACODE_ICD9_1 contains invalid codes:

. qui icd9  gen  ICD_spirit = ACODE_ICD9_1     if  (ivicd1 ==0 ) , range("$spirit")       /*icd9*/

. gen cd_count=1

. gen cd_spirit_count=1 if ICD_spirit==1
(4,531,823 missing values generated)

. egen cd_`year2'=sum(cd_count), by(ID R)

. egen cd_`year2'_spirit=sum(cd_count) if ICD_spirit==1 , by(ID R)
(4,531,823 missing values generated)

. replace cd_`year2'=0 if missing(cd_`year2'_spirit)
(4,531,823 real changes made)

. replace cd_`year2'_spirit=0 if missing(cd_`year2'_spirit)
(4,531,823 real changes made)

. tempfile ID_R_CD_`year2'

. keep ID R ID_BIRTHDAY cd_`year2' cd_`year2'_spirit 

. duplicates drop ID R, force

Duplicates in terms of ID R

(365,202 observations deleted)

. qui compress

. save `ID_R_CD_`year2'',replace
(note: file C:\Users\user\AppData\Local\Temp\ST_3788_000007.tmp not found)
file C:\Users\user\AppData\Local\Temp\ST_3788_000007.tmp saved

. 
. 
. use `unique_R_cross_ID'

. joinby ID R using `ID_R_CD_`year1'',unmatched(master)

. drop _merge

. joinby ID R using `ID_R_CD_`year2'',unmatched(master)

. drop _merge

. qui compress

. 
. 
. replace cd_`year1'=0 if missing(cd_`year1')
(101,256,411 real changes made)

. replace cd_`year1'_spirit=0 if missing(cd_`year1'_spirit)
(101,256,411 real changes made)

. replace cd_`year2'=0 if missing(cd_`year2')
(100,760,906 real changes made)

. replace cd_`year2'_spirit=0 if missing(cd_`year2'_spirit)
(100,760,906 real changes made)

. 
. 
. destring ID_BIRTHDAY,replace
ID_BIRTHDAY: all characters numeric; replaced as long

. bysort ID :egen birth = max(ID_BIRTHDAY)

. qui gen sex0 = 1 if ID_SEX=="M"

. qui replace sex0 = 0 if ID_SEX=="F"

. bysort ID :egen sex = max(sex0)
(22,627 missing values generated)

. tostring sex,replace
sex was float now str1

. qui replace sex = "M" if sex=="1"

. qui replace sex = "F" if sex=="0"

. cap drop sex0

. 
. egen IDN=count(ID),by(ID)

. tab IDN

        IDN |      Freq.     Percent        Cum.
------------+-----------------------------------
        121 |101,314,147       96.39       96.39
        242 |  3,674,528        3.50       99.88
        363 |    103,455        0.10       99.98
        484 |     10,648        0.01       99.99
        605 |      2,420        0.00       99.99
        726 |        726        0.00       99.99
       1452 |      1,452        0.00      100.00
       4356 |      4,356        0.00      100.00
------------+-----------------------------------
      Total |105,111,732      100.00

. drop if IDN !=1+($dayrange)*2
(3,797,585 observations deleted)

. save CD`year1'_`year2',replace
file CD2004_2005.dta saved

. 
. 
. 
. 
. global dayrange1 =$dayrange

. global wrange1 =$wrange

. 
. 
. tostring ID_BIRTHDAY, replace
ID_BIRTHDAY was long now str6

. replace ID_BIRTHDAY=ID_BIRTHDAY+"20"
variable ID_BIRTHDAY was str6 now str8
(101,314,147 real changes made)

. gen D_ID_BIRTHDAY=date("`year1'0320","YMD")-date(ID_BIRTHDAY,"YMD")

. cap drop age1019 age2029 age3039 age4049 age5059 age6069 age7099

. 
. global age ="10 20 30 40 50 60 70"

. foreach age of global age{
  2. local `age'_min  = `year1' - `age'
  3. local `age'_max  = `year1' - (`age'+10)
  4. 
. scalar min_`age'=date("`year1'0320","YMD")-date("``age'_min'0320","YMD")
  5. scalar max_`age'=date("`year1'0320","YMD")-date("``age'_max'0320","YMD")
  6. local c=substr("`age'",1,1)
  7. local age1=`age'+9 + (`c'==7)*20
  8. local gr="gen"
  9. if `c'>1{
 10.             local gr="replace"
 11.           }
 12. `gr'  age_group=`c' if D_ID_BIRTHDAY>= min_`age' & D_ID_BIRTHDAY< max_`age'
 13. gen     age`age'`age1'  = age_group==`c'
 14. }
(86,884,655 missing values generated)
(16,644,034 real changes made)
(16,829,406 real changes made)
(16,645,002 real changes made)
(10,668,933 real changes made)
(6,566,670 real changes made)
(3,906,122 real changes made)

. 
. 
. /*----------------------------------------------------------------------------*/                    
>                                                                                                     
>                         
. 
. /*merge ID　AREA_NO_I*/
. sort ID

. merge m:m ID using "$datapath\ID.dta",nogen keep(master match) keepusing(ID AREA_NO_I)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                       101,314,147  
    -----------------------------------------

. 
. /*百萬人次裡面的地區代碼 是city98*/
. qui gen cityno98 = AREA_NO_I

. sort cityno98 

. merge m:1 cityno98 using "D:\User_Data\Desktop\kan-2\1_Million\CD_townshipnumber98_20200512.dta",nog
> en keep(master match) 

    Result                           # of obs.
    -----------------------------------------
    not matched                         3,871
        from master                     3,871  
        from using                          0  

    matched                       101,310,276  
    -----------------------------------------

. 
. sort countytown

. merge m:1 countytown using "D:\User_Data\Desktop\kan-2\1_Million\Taiwan_Presidential_Election_Data_B
> Ytown_2004.dta",nogen keep(master match) 

    Result                           # of obs.
    -----------------------------------------
    not matched                    41,264,870
        from master                41,264,870  
        from using                          0  

    matched                        60,049,277  
    -----------------------------------------

. 
. qui gen DDPtownP  = DDPtown/validtown

. qui gen KMTtownP  = KMTtown/validtown

. 
. sum DDPtownP 

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    DDPtownP | 60,049,277     .484955    .0974956   .0355649   .7337663

. cap drop  qDDPtownP

. qui xtile qDDPtownP  = DDPtownP ,nq(4)

. 
. /*gap = 0 票數接近中間的50%*/
. qui gen gap = 1 if qDDPtownP ==1 | qDDPtownP==4

. qui replace gap = 0 if qDDPtownP ==2 | qDDPtownP==3

. tab gap

        gap |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 27,776,053       46.26       46.26
          1 | 32,273,224       53.74      100.00
------------+-----------------------------------
      Total | 60,049,277      100.00

. /*----------------------------------------------------------------------------*/                    
>                                                                                                     
>                                         
. gen Dpsy=cd_`year1'_spirit-cd_`year2'_spirit

. gen Dcd =cd_`year1'-cd_`year2'

. 
. 
. gen R1=R+date("`year1'0320","YMD")

. gen Rw6=wofd(R1+1)

. gen Rw3=wofd(R1-2)

. gen Rw =wofd(R1)

. 
. cap drop  scd_`year1'

. cap drop  scd_`year2'

. tostring Rw6, gen(W6)
W6 generated as str4

. tostring Rw3, gen(W3)
W3 generated as str4

. 
. gen IDW6=ID+W6

